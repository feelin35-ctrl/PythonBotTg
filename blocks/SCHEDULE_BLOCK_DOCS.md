# Блок расписания (Schedule Block)

## Назначение
Блок расписания предназначен для организации записи пользователей на определенные даты и время через Telegram-бот. Блок позволяет задавать вопросы пользователю о дате и времени, проверять доступность слотов и интегрироваться с CRM-системами для получения актуальной информации о занятости.

## Конфигурация

### Параметры настройки

| Параметр | Тип | Описание | По умолчанию |
|---------|------|----------|-------------|
| dateQuestion | string | Вопрос для выбора даты | "На какую дату вы хотите записаться?" |
| timeQuestion | string | Вопрос для выбора времени | "На какое время вы хотите записаться?" |
| minDate | date | Минимальная доступная дата | today |
| maxDate | date | Максимальная доступная дата | today + 30 дней |
| timeInterval | integer | Интервал времени в минутах | 30 |
| workStartTime | string | Начало рабочего дня (ЧЧ:ММ) | "09:00" |
| workEndTime | string | Конец рабочего дня (ЧЧ:ММ) | "18:00" |
| crmIntegration | boolean | Включить интеграцию с CRM | false |
| crmEndpoint | string | URL для получения данных из CRM | "" |
| unavailableMessage | string | Сообщение при недоступном времени | "Извините, это время уже занято. Пожалуйста, выберите другое." |

## Структура данных узла

```json
{
  "id": "schedule-1",
  "type": "schedule",
  "data": {
    "label": "Блок расписания",
    "dateQuestion": "На какую дату вы хотите записаться?",
    "timeQuestion": "На какое время вы хотите записаться?",
    "minDate": "2023-06-01",
    "maxDate": "2023-07-31",
    "timeInterval": 30,
    "workStartTime": "09:00",
    "workEndTime": "18:00",
    "crmIntegration": true,
    "crmEndpoint": "https://api.crm.example.com/slots",
    "unavailableMessage": "Извините, это время уже занято. Пожалуйста, выберите другое."
  },
  "position": {
    "x": 300,
    "y": 200
  }
}
```

## Логика работы блока

1. Блок получает управление от ScenarioRunner
2. Отправляет пользователю вопрос о дате
3. Получает ответ с датой от пользователя
4. При включенной интеграции с CRM проверяет доступность даты
5. Отправляет пользователю вопрос о времени
6. Получает ответ со временем от пользователя
7. При включенной интеграции с CRM проверяет доступность времени
8. Если время доступно:
   - Отправляет подтверждение пользователю
   - Возвращает следующий узел
9. Если время недоступно:
   - Отправляет сообщение о недоступности
   - Возвращается к шагу 5 (выбор времени)

## Интеграция с CRM

### Структура API-запроса

Для проверки доступности слотов блок будет отправлять запросы к CRM-системе:

```
GET {crmEndpoint}?date={date}&time={time}
```

### Структура ответа от CRM

```json
{
  "available": true,
  "reason": "Свободно" // или "Занято", "Выходной" и т.д.
}
```

### Обработка ошибок

При недоступности CRM-сервиса блок:
1. Залогирует ошибку
2. Продолжит работу без проверки доступности (по умолчанию считает слот доступным)
3. Отправит предупреждение в логи

## Файлы реализации

- Backend: [schedule_block.py](schedule_block.py)
- Frontend: [ScheduleNode.js](../src/components/NodeTypes/ScheduleNode.js)
- Редактируемый компонент: Добавлен в [EditableNode.js](../src/components/NodeTypes/EditableNode.js)
- Тесты: [test_schedule_block.py](test_schedule_block.py)
- Регистрация: Добавлен в [block_registry.py](../core/block_registry.py) и [index.js](../src/components/NodeTypes/index.js)